<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* ================= ESTILOS GERAIS ================= */
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; --bg: #ecf0f1; --text: #2c3e50; }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* TELA LOGIN */
        #tela-login { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary), var(--secondary)); flex-direction: column; }
        .login-logo { max-width: 300px; margin-bottom: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .btn-login { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-login:hover { background: #2980b9; }

        /* DASHBOARD LAYOUT */
        #tela-dashboard { display: none; height: 100vh; }
        .sidebar { width: 250px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .sidebar h2 { text-align: center; padding: 20px 0; background: rgba(0,0,0,0.2); margin: 0; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; transition: 0.3s; }
        .sidebar li:hover, .sidebar li.ativo { background: var(--accent); }
        .sidebar li .material-icons { margin-right: 10px; }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-sair { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

        /* VIEW & TABELAS */
        .view-section { display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .toolbar input, .toolbar select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; flex: 1; }
        .btn-action { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; background: var(--secondary); display: flex; align-items: center; gap: 5px; }
        .btn-add { background: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; }
        tr:hover { background: #f1f1f1; }

        /* MODAIS */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; position: relative; animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .close:hover { color: #000; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-row { display: flex; gap: 15px; }
        .actions { text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        
        /* ESTILOS ESPECÍFICOS */
        .card-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .card { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { margin: 0; color: #7f8c8d; font-size: 14px; }
        .card .valor { font-size: 24px; font-weight: bold; color: var(--primary); margin-top: 10px; }
        
        /* CHECKBOX PERSONALIZADO (FINANCEIRO) */
        .opt-tipo { display: flex; gap: 10px; margin-bottom: 15px; }
        .opt-tipo div { flex: 1; padding: 10px; text-align: center; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .opt-tipo div.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .lista-sugestoes { list-style: none; padding: 0; margin: 0; border: 1px solid #ddd; position: absolute; width: 100%; background: white; max-height: 150px; overflow-y: auto; z-index: 10; display: none; }
        .lista-sugestoes li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .lista-sugestoes li:hover { background: #f0f0f0; }

        /* Parcelas Scroll */
        #container-parcelas-geradas { max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .item-parcela { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="tela-login">
        <img src="Logo.jpg" alt="Triboom Sorvetes Logo" class="login-logo">
        <div class="login-box">
            <h2>Triboom Sorvetes</h2>
            <input type="text" id="usuario" placeholder="Usuário">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn-login" id="btnLogin">ENTRAR</button>
            <p id="msg-erro" style="color: red; margin-top: 10px; font-size: 13px;"></p>
        </div>
    </div>

    <div id="tela-dashboard">
        <nav class="sidebar">
            <h2>Minha Empresa</h2>
            <ul>
                <li data-route="dashboard" class="ativo"><span class="material-icons">dashboard</span> Visão Geral</li>
                <li data-route="produtos"><span class="material-icons">inventory_2</span> Produtos & Estoque</li>
                <li data-route="notas_entrada"><span class="material-icons">receipt_long</span> Notas de Entrada</li>
                <li data-route="financeiro"><span class="material-icons">attach_money</span> Financeiro</li>
                <li data-route="usuarios"><span class="material-icons">people</span> Usuários</li>
                <li data-route="configuracoes"><span class="material-icons">settings</span> Configurações</li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="header">
                <h2 id="titulo-secao">DASHBOARD</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span>Olá, <b id="display-nome-usuario">Usuário</b></span>
                    <button class="btn-sair" id="btnSair">Sair</button>
                </div>
            </div>

            <div id="view-padrao" class="view-section">
                <div class="card-container">
                    <div class="card"><h3>Total Produtos</h3><div class="valor" id="resumo-qtd">0</div></div>
                    <div class="card"><h3>Valor Estoque</h3><div class="valor" id="resumo-valor">R$ 0,00</div></div>
                    <div class="card"><h3>Saldo Financeiro</h3><div class="valor" id="fin-saldo">R$ 0,00</div></div>
                </div>
                <div style="margin-top: 40px; text-align: center; color: #aaa;">
                    <span class="material-icons" style="font-size: 64px;">analytics</span>
                    <p>Selecione um menu ao lado para começar.</p>
                </div>
            </div>

            <div id="view-produtos" class="view-section">
                <div class="toolbar">
                    <input type="text" id="barra-pesquisa" placeholder="Buscar produto...">
                    <select id="filtro-grupo" style="max-width: 200px;"><option value="">Todos Grupos</option></select>
                    <button class="btn-action btn-add" id="btnAbrirNovoProduto"><span class="material-icons">add</span> Novo</button>
                    <button class="btn-action" id="btnAbrirContagem"><span class="material-icons">playlist_add_check</span> Contagem</button>
                    <button class="btn-action" id="btnPDFProdutos" style="background:#e74c3c"><span class="material-icons">picture_as_pdf</span> PDF</button>
                </div>
                <table>
                    <thead><tr><th>Cód.</th><th>Nome</th><th>Grupo</th><th>Qtd</th><th>Preço</th><th>Ações</th></tr></thead>
                    <tbody id="tabela-produtos-corpo"></tbody>
                </table>
            </div>

            <div id="view-notas-entrada" class="view-section">
                <div class="toolbar">
                    <button class="btn-action btn-add" id="btnLancarNotaManual"><span class="material-icons">edit_note</span> Lançamento Manual</button>
                    <button class="btn-action" id="btnImportarXML" style="background:#2ecc71"><span class="material-icons">upload_file</span> Importar XML</button>
                </div>
                <table>
                    <thead><tr><th>Data</th><th>Número</th><th>Fornecedor</th><th>Itens</th><th>Valor Total</th><th>Tipo</th><th>Ações</th></tr></thead>
                    <tbody id="tabela-notas-corpo"></tbody>
                </table>
            </div>

            <div id="view-financeiro" class="view-section">
                <div class="filters toolbar" style="margin-bottom: 10px;">
                    <input type="text" id="barra-pesquisa-financeiro" placeholder="Buscar lançamento...">
                    </div>
                <div class="toolbar">
                     <button class="btn-action btn-add" id="btnNovaDespesa"><span class="material-icons">add</span> Lançar Manual</button>
                    <button class="btn-action" id="btnPDFFinanceiro" style="background:#e74c3c"><span class="material-icons">picture_as_pdf</span> PDF</button>
                </div>
                
                <div style="display:flex; gap:20px; margin-bottom:15px; font-weight:bold;">
                    <span style="color:#27ae60">Receitas: <span id="fin-total-receitas">R$ 0,00</span></span>
                    <span style="color:#e74c3c">Despesas: <span id="fin-total-despesas">R$ 0,00</span></span>
                </div>

                <table>
                    <thead><tr>
                        <th>Vencimento</th><th>Descrição</th><th>Tipo</th><th>Valor</th><th>Status</th><th>Ações</th>
                    </tr></thead>
                    <tbody id="tabela-financeiro-corpo"></tbody>
                </table>
            </div>

            <div id="view-usuarios" class="view-section">
                <div class="toolbar">
                    <button class="btn-action btn-add" id="btnNovoUsuario"><span class="material-icons">add</span> Novo Usuário</button>
                </div>
                <table>
                    <thead><tr><th>Nome</th><th>Login</th><th>Perfil</th><th>Ações</th></tr></thead>
                    <tbody id="tabela-usuarios-corpo"></tbody>
                </table>
            </div>

            <div id="view-configuracoes" class="view-section">
                <h3>Grupos de Produtos</h3>
                <div class="toolbar">
                    <input type="text" id="novo-grupo-nome" placeholder="Nome do grupo">
                    <button class="btn-action btn-add" id="btnAddGrupo">Adicionar</button>
                </div>
                <table style="max-width: 500px;">
                    <thead><tr><th>Nome do Grupo</th><th>Ações</th></tr></thead>
                    <tbody id="tabela-config-grupos"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modal-produto" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Cadastro de Produto</h3>
            <form id="form-produto">
                <input type="hidden" id="prod_id_edit">
                <input type="hidden" id="is_edit">
                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>Código</label><input type="text" id="prod_codigo"></div>
                    <div class="form-group" style="flex:2"><label>Nome</label><input type="text" id="prod_nome"></div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>Grupo</label><select id="prod_grupo"></select></div>
                    <div class="form-group" style="flex:1"><label>Qtd</label><input type="number" id="prod_qtd" step="0.01"></div>
                    <div class="form-group" style="flex:1"><label>Preço</label><input type="number" id="prod_preco" step="0.01"></div>
                </div>
                <div class="actions"><button class="btn-action btn-add" id="btn-salvar-prod">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="modal-nota-manual" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close">&times;</span>
            <h3 id="titulo-modal-nota">Lançamento de Nota</h3>
            <form id="form-nota-manual">
                <input type="hidden" id="nota_id_edicao">
                <input type="hidden" id="nota_is_edit">
                
                <div class="form-row" style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <div class="form-group" style="flex:1"><label>Número</label><input type="text" id="nota_numero"></div>
                    <div class="form-group" style="flex:1"><label>Data</label><input type="date" id="nota_data"></div>
                    <div class="form-group" style="flex:2"><label>Fornecedor</label><input type="text" id="nota_fornecedor"></div>
                </div>

                <div style="border-top: 1px dashed #ccc; padding-top: 10px; margin-bottom: 10px;">
                    <label style="font-weight:bold; color:var(--accent);">Adicionar Produto à Nota</label>
                    <div class="form-row" style="position: relative;">
                        <div class="form-group" style="flex:2">
                            <input type="text" id="input-item-busca" placeholder="Buscar produto..." autocomplete="off">
                            <input type="hidden" id="input-item-codigo">
                            <ul id="lista-sugestoes-manual" class="lista-sugestoes"></ul>
                        </div>
                        <div class="form-group" style="flex:1"><input type="number" id="input-item-qtd" placeholder="Qtd"></div>
                        <div class="form-group" style="flex:1"><input type="number" id="input-item-preco" placeholder="Valor Unit."></div>
                        <button type="button" class="btn-action" id="btnAddItemNota" style="height: 42px; margin-top: 24px;">+</button>
                    </div>
                </div>

                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee;">
                    <table>
                        <thead><tr><th>Cód</th><th>Produto</th><th>Qtd</th><th>Unit.</th><th>Total</th><th></th></tr></thead>
                        <tbody id="tabela-itens-nota-manual"></tbody>
                    </table>
                </div>
                <div id="msg-sem-itens" style="text-align:center; padding:10px; color:#aaa;">Nenhum item adicionado</div>

                <div style="text-align:right; margin-top:10px; font-size:18px;">
                    Qtd: <b id="display-total-qtd">0</b> | Total: <b id="display-total-valor" style="color:var(--accent)">R$ 0,00</b>
                </div>

                <div class="actions">
                    <button class="btn-action btn-add" id="btn-salvar-nota">Salvar Nota Completa</button>
                    </div>
            </form>
        </div>
    </div>

    <div id="modal-nova-despesa" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Lançamento Financeiro</h3>
            <form id="form-financeiro-manual">
                <input type="hidden" id="fin_man_id">
                
                <div class="opt-tipo">
                    <div id="opt-despesa" class="selected">Despesa (Pagar)</div>
                    <div id="opt-receita">Receita (Receber)</div>
                </div>

                <div class="form-group"><label>Descrição</label><input type="text" id="fin_man_descricao"></div>
                <div class="form-group"><label>Fornecedor / Cliente</label><input type="text" id="fin_man_fornecedor"></div>
                
                <div class="form-row">
                    <div class="form-group"><label>Valor Total</label><input type="number" id="fin_man_valor" step="0.01"></div>
                    <div class="form-group"><label>Status</label>
                        <select id="fin_man_status">
                            <option value="Pendente">Pendente</option>
                            <option value="Pago">Pago</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Emissão</label><input type="date" id="fin_man_emissao"></div>
                    <div class="form-group"><label>1º Vencimento</label><input type="date" id="fin_man_vencimento"></div>
                </div>

                <div class="actions"><button class="btn-action btn-add" id="btn-salvar-fin-manual">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="modal-contagem" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Contagem / Ajuste de Estoque</h3>
            <div class="form-row" style="position:relative;">
                <div class="form-group" style="flex:3">
                    <input type="text" id="input-busca-contagem" placeholder="Buscar produto..." autocomplete="off">
                    <ul id="lista-sugestoes-contagem" class="lista-sugestoes"></ul>
                </div>
                <div class="form-group" style="flex:1"><input type="number" id="input-qtd-contagem" placeholder="Nova Qtd" disabled></div>
                <button class="btn-action" id="btn-add-contagem" disabled>OK</button>
            </div>
            
            <table style="margin-top:10px;">
                <thead><tr><th>Produto</th><th>Atual</th><th>Nova</th><th>Dif</th><th></th></tr></thead>
                <tbody id="lista-contagem-corpo"></tbody>
            </table>
            <p id="msg-vazio-contagem" style="text-align:center; color:#ccc; padding:20px;">Lista vazia</p>
            
            <div class="form-group"><label>Observação (Opcional)</label><input type="text" id="obs-contagem"></div>
            <div class="actions"><button class="btn-action btn-add" id="btnSalvarContagem">Processar Ajuste</button></div>
        </div>
    </div>

    <div id="modal-importar-xml" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Importar XML (NFe)</h3>
            <div style="padding: 30px; border: 2px dashed #ccc; text-align: center; margin: 20px 0;">
                <input type="file" id="file-xml" accept=".xml">
                <p style="color:#888; margin-top:10px;">Selecione o arquivo .xml da nota fiscal</p>
            </div>
            <div class="actions"><button class="btn-action btn-add" id="btn-processar-xml">Importar e Salvar</button></div>
        </div>
    </div>

    <div id="modal-usuario" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Usuário</h3>
            <form id="form-usuario">
                <input type="hidden" id="usuario_id_edit">
                <div class="form-group"><label>Nome</label><input type="text" id="user_nome"></div>
                <div class="form-group"><label>Login</label><input type="text" id="user_login"></div>
                <div class="form-group"><label>Senha</label><input type="password" id="user_senha"></div>
                <div class="form-group"><label>Perfil</label>
                    <select id="user_perfil">
                        <option value="Admin">Admin</option>
                        <option value="Usuario">Usuário</option>
                    </select>
                </div>
                <div class="actions"><button class="btn-action btn-add" id="btn-salvar-usuario">Salvar</button></div>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    
    <script src="app.js"></script>

</body>
</html>